<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deli-Drop — Campus Food Delivery (Prototype)</title>
  <meta name="description" content="Deli-Drop prototype — student-focused campus food ordering UI. Accessible, responsive, and interactive single-file demo." />
  <style>
    /*
      Deli-Drop — Single-file Prototype (matches project plan)
      - Implements only the functionality described in the project plan.
      - Front-end only (mock/demo data), accessible (WCAG AA basics), responsive.
      - Contains: user accounts (mock), vendor listings & menus, search & filters,
                  ordering & checkout, simulated real-time tracking, peer-to-peer driver mock,
                  group & split orders, ratings & reviews, notifications & feedback,
                  accessibility support (contrast, keyboard), and responsive layout.
    */

    :root{
      --bg:#0b0f19;
      --panel:rgba(18,24,36,0.7);
      --glass:rgba(255,255,255,0.03);
      --brand:#4f9cff;
      --accent:#ff8a65;
      --muted:#9aa6bf;
      --text:#e6eef8;
      --radius:12px;
      --gap:12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      font-size:15px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    header{background:linear-gradient(90deg,var(--brand),#6bc8ff);padding:18px;border-bottom-left-radius:14px;border-bottom-right-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6);position:sticky;top:0;z-index:60}
    .container{max-width:1100px;margin:18px auto;padding:0 18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:10px;background:#fff;color:var(--brand);display:flex;align-items:center;justify-content:center;font-weight:800}
    header h1{margin:0;font-size:19px}
    header .meta{color:rgba(255,255,255,0.95);font-size:13px}

    nav{margin-left:auto;display:flex;gap:10px;align-items:center}
    .nav-btn{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .nav-btn:focus{outline:3px solid rgba(79,156,255,0.28);outline-offset:2px}

    .hero{background:linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.35)), url('https://images.unsplash.com/photo-1544025162-d76694265947?q=80&w=1600&auto=format&fit=crop&ixlib=rb-4.0.3&s=') center/cover no-repeat;border-radius:12px;padding:36px;margin-top:18px;box-shadow:0 12px 50px rgba(0,0,0,0.6)}
    .hero-inner{display:flex;gap:20px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .hero-left{max-width:640px}
    .hero h2{margin:0;font-size:26px}
    .hero p{color:var(--muted);margin:10px 0 18px;line-height:1.4}
    .cta-row{display:flex;gap:10px;align-items:center}
    .btn{background:var(--brand);color:white;padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn.alt{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text)}
    .drag-hint{font-size:12px;color:var(--muted);margin-top:8px}

    main{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:20px}
    @media (max-width:980px){main{grid-template-columns:1fr}.right-col{order:2}}

    .card{background:var(--panel);padding:14px;border-radius:var(--radius);box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .card h3{margin:0 0 10px 0}
    .muted{color:var(--muted);font-size:13px}

    .search{display:flex;gap:10px;align-items:center}
    .search input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{padding:7px 12px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:var(--muted);cursor:pointer}
    .chip.active{background:linear-gradient(90deg,var(--brand),#6bc8ff);color:#02122a;border:1px solid rgba(0,0,0,0.12);font-weight:600}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:12px}
    @media (max-width:680px){.grid{grid-template-columns:1fr}}

    .vendor{display:flex;gap:12px;align-items:flex-start}
    .vendor .img{width:86px;height:86px;border-radius:10px;overflow:hidden;flex:0 0 86px;background:#111}
    .vendor img{width:100%;height:100%;object-fit:cover;display:block}
    .vendor .meta{flex:1}
    .vendor h4{margin:0;font-size:16px}
    .badges{display:flex;gap:8px;margin-top:8px}
    .badge{padding:5px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-size:12px;border:1px solid rgba(255,255,255,0.03)}

    #menuCard{margin-top:12px}
    .menu{margin-top:10px}
    .menu-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:1px dashed rgba(255,255,255,0.03)}
    .menu-item:first-child{border-top:none}
    .menu-item .left{max-width:72%}
    .menu-item .right{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .price{font-weight:700}

    .cart{position:sticky;top:22px}
    .cart .items{max-height:340px;overflow:auto;margin-top:10px;padding-right:8px}
    .cart .item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;margin-bottom:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.03)}
    .cart .item .left{max-width:60%}
    .cart .item input[type="number"]{width:60px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    .total-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}

    .progress{height:12px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;margin-top:8px}
    .progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--brand),#6bc8ff)}

    .profile-row{display:flex;gap:10px;align-items:center}
    .profile-avatar{width:46px;height:46px;border-radius:10px;background:linear-gradient(90deg,var(--brand),#6bc8ff);display:flex;justify-content:center;align-items:center;color:#02122a;font-weight:700}

    .group-box{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .group-members{display:flex;gap:8px;flex-wrap:wrap}
    .member-pill{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);font-size:13px}

    .review{border-top:1px dashed rgba(255,255,255,0.03);padding:10px 0}
    .rating{color:var(--accent);font-weight:700}

    :focus{outline:3px solid rgba(79,156,255,0.22);outline-offset:2px}
    @media (prefers-reduced-motion: reduce){*{transition:none!important}}
  </style>
</head>
<body>
  <header role="banner">
    <div class="container" style="display:flex;align-items:center;">
      <div class="brand" style="min-width:0">
        <div class="logo" aria-hidden="true">DD</div>
        <div style="min-width:0">
          <h1>Deli-Drop</h1>
          <div class="meta">Student-powered campus deliveries — quick, affordable, accessible</div>
        </div>
      </div>

      <nav aria-label="Main navigation" role="navigation" style="margin-left:auto">
        <button class="nav-btn" id="focusSearch" title='Press "/" to focus search'>/ Search</button>
        <button class="nav-btn" id="openProfile" title="Open mock profile">Profile</button>
      </nav>
    </div>
  </header>

  <div class="container">
    <section class="hero" role="region" aria-labelledby="hero-heading">
      <div class="hero-inner">
        <div class="hero-left">
          <h2 id="hero-heading">Deli-Drop — campus delivery built for students</h2>
          <p>Fast campus vendors, peer drivers, group ordering, accessibility support, and simulated real-time tracking — designed to match the project plan.</p>
          <div class="cta-row">
            <button class="btn" id="quickOrder">Order Now</button>
            <button class="btn alt" id="howItWorks">How it works</button>
            <div class="drag-hint">Tip: click "View menu" to open vendor menus, then add items to cart.</div>
          </div>
          <div style="margin-top:12px" class="muted">Supports: saved delivery locations, dietary preferences, and order history (demo/local only).</div>
        </div>

        <div style="min-width:220px;text-align:right">
          <div class="card" style="padding:12px;border-radius:10px;">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="muted">Profile</div>
                <div style="font-weight:800;font-size:18px" id="profileSummary">Guest Student</div>
                <div class="muted" style="font-size:13px" id="profileEmail">Not signed in</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <main>
      <section aria-labelledby="explore-heading">
        <div class="card" role="region" aria-label="Search and filters">
          <div style="display:flex;align-items:center;gap:12px">
            <div style="flex:1">
              <label for="search" class="muted">Search restaurants or dishes</label>
              <div class="search" style="margin-top:6px">
                <input id="search" type="search" placeholder="pizza, vegan, student-run, halal..." aria-autocomplete="list" aria-controls="vendorList" />
                <button id="clearSearch" class="btn alt" aria-label="Clear search">Clear</button>
              </div>
            </div>
            <div style="width:160px">
              <label class="muted">Sort</label>
              <select id="sort" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
                <option value="popular">Popular</option>
                <option value="eta">Fastest</option>
                <option value="rating">Top rated</option>
              </select>
            </div>
          </div>

          <div class="filters" role="toolbar" aria-label="Quick filters">
            <button class="chip" data-filter="vegan">Vegan</button>
            <button class="chip" data-filter="student">Student-run</button>
            <button class="chip" data-filter="fast">Under 20 min</button>
            <button class="chip" data-filter="halal">Halal</button>
            <button class="chip" data-filter="popular">Popular</button>
          </div>
        </div>

        <div class="card" role="region" aria-labelledby="explore-heading" style="margin-top:12px">
          <h3 id="explore-heading">Nearby Vendors</h3>
          <div id="vendorList" class="grid" aria-live="polite" tabindex="0"></div>
        </div>

        <div class="card" id="menuCard" hidden aria-hidden="true" aria-live="polite" style="margin-top:12px">
          <h3 id="menuTitle">Menu</h3>
          <div id="menuItems" class="menu"></div>
          <div style="margin-top:8px" class="drag-hint muted">Add items to the cart. You can adjust quantities and proceed to checkout.</div>
        </div>

        <div class="card" id="trackingCard" hidden aria-hidden="true" style="margin-top:12px">
          <h3>Order Tracking</h3>
          <div class="small" id="trackingStatus">No active orders</div>
          <div class="progress" aria-hidden="false" style="margin-top:8px"><span id="progressBar" style="width:0%"></span></div>
          <div style="margin-top:10px" aria-live="polite"><small class="muted">Estimated delivery: <span id="eta">—</span></small></div>
          <div style="margin-top:12px">
            <button id="viewReceipt" class="btn alt">View receipt</button>
            <button id="reportIssue" class="btn" style="margin-left:8px">Report issue</button>
          </div>
        </div>

        <div class="card" id="reviewsCard" style="margin-top:12px">
          <h3>Ratings & Reviews</h3>
          <div class="muted">Leave a rating and short review after delivery (demo/local only).</div>
          <div id="reviewsList" style="margin-top:10px"></div>
        </div>
      </section>

      <aside class="right-col">
        <div class="card cart" role="complementary" aria-labelledby="cartHeading">
          <h3 id="cartHeading">Your Cart</h3>
          <div class="muted">Select delivery location and payment (mock). You can split bills for group orders.</div>

          <label class="muted" for="addressSelect" style="margin-top:10px;display:block">Delivery location</label>
          <select id="addressSelect" aria-label="Delivery location" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
            <option value="Dorm A">Dorm A — Room 102</option>
            <option value="Dorm B">Dorm B — Main Hall</option>
            <option value="Library">Library — South Entrance</option>
          </select>

          <div class="items" id="cartItems" aria-live="polite"></div>

          <div class="total-row">
            <div><strong>Total:</strong> <span id="total">R0.00</span></div>
            <div style="display:flex;gap:8px">
              <button id="checkoutBtn" class="btn" disabled>Checkout</button>
              <button id="groupBtn" class="btn alt">Group Order</button>
            </div>
          </div>

          <hr style="border:none;border-top:1px dashed rgba(255,255,255,0.03);margin:12px 0">

          <div class="small">Quick actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="saveProfileBtn" class="chip">Save preferences</button>
            <button id="applyDriverBtn" class="chip">Become a driver</button>
            <button id="referralBtn" class="chip">Refer & Earn</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Accessibility</h4>
          <p class="muted">High contrast, larger text, full keyboard navigation (basic toggles).</p>
          <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
            <button id="contrastBtn" class="chip" aria-pressed="false">High contrast</button>
            <button id="textBtn" class="chip" aria-pressed="false">Larger text</button>
            <button id="reduceAnim" class="chip" aria-pressed="false">Reduce motion</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4>Profile</h4>
          <div class="profile-row" style="margin-top:8px">
            <div class="profile-avatar" aria-hidden="true">M</div>
            <div>
              <div style="font-weight:700" id="profileName">Guest Student</div>
              <div class="muted" id="profileEmail2">Not signed in</div>
            </div>
          </div>

          <label class="muted" for="dietPref" style="margin-top:12px;display:block">Dietary preference</label>
          <select id="dietPref" style="width:100%;margin-top:6px;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)">
            <option value="none">None</option>
            <option value="vegan">Vegan</option>
            <option value="halal">Halal</option>
            <option value="glutenfree">Gluten-free</option>
          </select>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveProfileLocal" class="btn alt">Save</button>
            <button id="loadProfileLocal" class="btn">Load</button>
          </div>
        </div>
      </aside>
    </main>

    <footer style="margin-top:22px;padding:18px;border-top:1px solid rgba(255,255,255,0.03);text-align:center" role="contentinfo">
      Prototype UI — demonstrates features listed in the project plan. Data persisted only in localStorage for demo purposes.
    </footer>
  </div>

  <script>
    /*
      Script implements only functionality described in the project plan:
      - Vendors & menus (client-side mock)
      - Search & filters
      - Ordering & checkout (mock, local only)
      - Real-time order tracking (simulated)
      - Peer-to-peer driver mock (apply UI)
      - Group & split orders (mock creation + splitting UI)
      - Ratings & reviews (local)
      - Notifications & feedback (ARIA live announcements)
      - Accessibility toggles and basic persistence (localStorage)
    */

    /* ---------- Demo vendor data (client-side) ---------- */
    const VENDORS = [
      {id:1,name:"Campus Pizza",desc:"Fast pizza slices — student favourite",tags:["fast","popular"],eta:18,rating:4.7, student:false, img:"https://images.unsplash.com/photo-1601924582971-3b9f0b2db1d2?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=",menu:[
        {id:'p1',name:'Margherita',price:45,desc:'Classic cheese & tomato'},
        {id:'p2',name:'Pepperoni',price:55,desc:'Spicy pepperoni slices'},
        {id:'p3',name:'Vegan Delight',price:60,desc:'Plant-based cheese & veggies'}
      ]},
      {id:2,name:"Green Bowl",desc:"Healthy bowls and salads",tags:["healthy","vegan"],eta:25,rating:4.6, student:true,img:"https://images.unsplash.com/photo-1540189549336-e6e99c3679fe?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=",menu:[
        {id:'g1',name:'Quinoa Bowl',price:65,desc:'Quinoa, greens, roasted veg'},
        {id:'g2',name:'Kale Caesar',price:55,desc:'Kale, croutons, vegan dressing'}
      ]},
      {id:3,name:"Wrap & Roll (Student Run)",desc:"Student-run kitchen — homestyle wraps",tags:["student","fast"],eta:20,rating:4.8, student:true,img:"https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=",menu:[
        {id:'w1',name:'Chicken Wrap',price:50,desc:'Grilled chicken & slaw'},
        {id:'w2',name:'Falafel Wrap',price:48,desc:'Crispy falafel & hummus'}
      ]},
      {id:4,name:"Curry Corner",desc:"Comforting curries & rice",tags:["halal","popular"],eta:30,rating:4.5, student:false,img:"https://images.unsplash.com/photo-1604908177522-3b7d0c6a7c15?q=80&w=800&auto=format&fit=crop&ixlib=rb-4.0.3&s=",menu:[
        {id:'c1',name:'Butter Chicken',price:70,desc:'Creamy spiced chicken'},
        {id:'c2',name:'Chana Masala',price:55,desc:'Chickpeas in tomato gravy'}
      ]}
    ];

    /* ---------- Utilities & app state ---------- */
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));
    const formatZAR = v => 'R' + Number(v).toFixed(2);

    let state = {
      vendors: VENDORS.slice(),
      cart: JSON.parse(localStorage.getItem('dd_cart') || '[]'),            // cart items
      profile: JSON.parse(localStorage.getItem('dd_profile') || '{}'),     // profile (mock)
      settings: JSON.parse(localStorage.getItem('dd_settings') || '{}'),   // accessibility
      activeOrder: JSON.parse(localStorage.getItem('dd_active') || 'null'),
      group: JSON.parse(localStorage.getItem('dd_group') || 'null'),
      reviews: JSON.parse(localStorage.getItem('dd_reviews') || '[]')
    };

    // DOM refs
    const vendorList = qs('#vendorList');
    const menuCard = qs('#menuCard');
    const menuItems = qs('#menuItems');
    const menuTitle = qs('#menuTitle');
    const cartItems = qs('#cartItems');
    const totalEl = qs('#total');
    const checkoutBtn = qs('#checkoutBtn');
    const trackingCard = qs('#trackingCard');
    const trackingStatus = qs('#trackingStatus');
    const progressBar = qs('#progressBar');
    const etaEl = qs('#eta');
    const reviewsList = qs('#reviewsList');

    /* ---------- Render vendors ---------- */
    function renderVendors(list){
      vendorList.innerHTML = '';
      if(list.length===0){ vendorList.innerHTML = '<div class="card">No vendors match your search.</div>'; return; }
      list.forEach(v=>{
        const el = document.createElement('div'); el.className='card vendor'; el.tabIndex=0;
        el.innerHTML = `
          <div class="img"><img src="${v.img}" alt="${v.name} photo" /></div>
          <div class="meta">
            <h4>${v.name} <small class="muted">• ${v.rating}★</small></h4>
            <div class="muted">${v.desc}</div>
            <div class="badges">
              <div class="badge">${v.eta} min</div>
              ${v.student?'<div class="badge">Student-run</div>':''}
            </div>
            <div style="margin-top:8px">
              <button class="btn" data-open="${v.id}" aria-label="View menu for ${v.name}">View menu</button>
              <button class="btn alt" data-follow="${v.id}" style="margin-left:8px">Follow</button>
            </div>
          </div>`;
        vendorList.appendChild(el);
      });
    }

    vendorList.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-open]');
      if(!btn) return;
      openMenu(Number(btn.dataset.open));
    });

    /* ---------- Open menu ---------- */
    function openMenu(id){
      const v = state.vendors.find(x=>x.id===id);
      if(!v) return;
      menuTitle.textContent = v.name + ' — Menu';
      menuItems.innerHTML = '';
      v.menu.forEach(it=>{
        const row = document.createElement('div'); row.className='menu-item';
        row.innerHTML = `
          <div class="left">
            <div style="font-weight:700">${it.name} <span class="muted">• ${formatZAR(it.price)}</span></div>
            <div class="muted">${it.desc}</div>
          </div>
          <div class="right">
            <div class="muted">From ${v.name}</div>
            <div style="display:flex;gap:8px">
              <button class="btn" data-add='${JSON.stringify({vendorId:v.id,itemId:it.id})}' aria-label="Add ${it.name} to cart">Add</button>
              <button class="btn alt" data-preview='${JSON.stringify({vendorId:v.id,itemId:it.id})}' aria-label="Preview ${it.name}">Preview</button>
            </div>
          </div>
        `;
        menuItems.appendChild(row);
      });
      menuCard.hidden = false; menuCard.removeAttribute('aria-hidden');
      menuCard.scrollIntoView({behavior:'smooth',block:'center'});
    }

    /* ---------- Add to cart (button) ---------- */
    document.body.addEventListener('click', e=>{
      const add = e.target.closest('button[data-add]');
      if(add){
        const payload = JSON.parse(add.dataset.add);
        addToCart(payload.vendorId,payload.itemId);
      }
      const preview = e.target.closest('button[data-preview]');
      if(preview){
        const payload = JSON.parse(preview.dataset.preview);
        const vendor = state.vendors.find(v=>v.id===payload.vendorId);
        const item = vendor.menu.find(m=>m.id===payload.itemId);
        // simple preview modal (alert for demo)
        alert(item.name + "\n\n" + item.desc + "\nPrice: " + formatZAR(item.price));
      }
      const follow = e.target.closest('button[data-follow]');
      if(follow){
        // following is mentioned in plan (vendors can promote). Demo action only.
        alert('You are now following this vendor (demo).');
      }
    });

    function addToCart(vendorId,itemId){
      const vendor = state.vendors.find(v=>v.id===vendorId);
      const item = vendor.menu.find(m=>m.id===itemId);
      const cartItem = {uid:Date.now() + Math.random(), vendorId, vendorName:vendor.name, itemId:item.id, name:item.name, price:item.price, qty:1};
      state.cart.push(cartItem);
      persistCart();
      renderCart();
      announce('Added ' + item.name + ' to cart');
    }

    /* ---------- Render cart ---------- */
    function renderCart(){
      cartItems.innerHTML = '';
      if(state.cart.length === 0){
        cartItems.innerHTML = '<div class="muted">Cart is empty — add items from vendor menus.</div>';
        checkoutBtn.disabled = true;
        totalEl.textContent = formatZAR(0);
        return;
      }
      let total = 0;
      state.cart.forEach(ci=>{
        total += ci.price * ci.qty;
        const el = document.createElement('div'); el.className = 'item';
        el.innerHTML = `
          <div class="left"><div style="font-weight:700">${ci.name}</div><div class="muted">${ci.vendorName}</div></div>
          <div style="display:flex;align-items:center;gap:8px">
            <div class="muted">${formatZAR(ci.price)}</div>
            <input aria-label="Quantity for ${ci.name}" type="number" min="1" value="${ci.qty}" data-uid="${ci.uid}" />
            <button class="chip" data-remove="${ci.uid}">Remove</button>
          </div>
        `;
        cartItems.appendChild(el);
      });
      totalEl.textContent = formatZAR(total);
      checkoutBtn.disabled = false;
    }

    cartItems.addEventListener('input', e=>{
      const q = e.target.closest('input[type="number"]');
      if(!q) return;
      const uid = q.dataset.uid; const val = Number(q.value) || 1;
      const it = state.cart.find(c=>c.uid == uid); if(it){ it.qty = val; persistCart(); renderCart(); }
    });

    cartItems.addEventListener('click', e=>{
      const rm = e.target.closest('button[data-remove]');
      if(!rm) return;
      const uid = rm.dataset.remove; state.cart = state.cart.filter(c=>c.uid != uid); persistCart(); renderCart();
    });

    function persistCart(){ localStorage.setItem('dd_cart', JSON.stringify(state.cart)); }

    /* ---------- Checkout & tracking (simulated) ---------- */
    checkoutBtn.addEventListener('click', ()=> {
      if(state.cart.length === 0){ alert('Cart empty'); return; }
      // Create an active order object as per the project plan (simulated)
      const location = qs('#addressSelect').value;
      state.activeOrder = {
        id: Date.now(),
        items: state.cart.slice(),
        location,
        progress: 0,
        eta: Math.max(15, Math.round(Math.random()*35)), // estimated minutes
        status: 'Order received'
      };
      localStorage.setItem('dd_active', JSON.stringify(state.activeOrder));
      // Add to order history in profile (local mock)
      state.profile.history = state.profile.history || [];
      state.profile.history.push({orderId: state.activeOrder.id, items: state.activeOrder.items, location, placedAt: new Date().toISOString()});
      localStorage.setItem('dd_profile', JSON.stringify(state.profile));
      // Clear cart
      state.cart = []; persistCart(); renderCart();
      // Start tracking simulation
      startTrackingSimulation(state.activeOrder);
      announce('Order placed. Tracking started.');
    });

    function startTrackingSimulation(order){
      trackingCard.hidden = false; trackingCard.removeAttribute('aria-hidden');
      trackingStatus.textContent = 'Order received — preparing';
      progressBar.style.width = '0%'; etaEl.textContent = order.eta + ' mins';
      let p = 0;
      const interval = setInterval(()=>{
        p += 10; order.progress = p; progressBar.style.width = p + '%';
        if(p === 20) trackingStatus.textContent = 'Order received — preparing';
        if(p === 50) trackingStatus.textContent = 'In progress — driver heading to vendor';
        if(p === 80) trackingStatus.textContent = 'Out for delivery — on the way';
        if(p >= 100){ trackingStatus.textContent = 'Delivered — enjoy your meal!'; clearInterval(interval);
          // After delivery, allow leaving a review (project plan)
          setTimeout(()=>{ announce('Order delivered. You may leave feedback.'); }, 800);
          // store delivered order for review reference
          localStorage.removeItem('dd_active');
          // optionally add to profile delivered items (already in profile.history)
          // hide tracking after short time
          setTimeout(()=>{ trackingCard.hidden = true; }, 3500);
        }
      }, 1000);
    }

    // restore active order at load
    if(state.activeOrder){ startTrackingSimulation(state.activeOrder); }

    /* ---------- Search & filters (smart search basics) ---------- */
    qs('#search').addEventListener('input', e=>{
      const q = e.target.value.toLowerCase().trim();
      const filtered = state.vendors.filter(v => v.name.toLowerCase().includes(q) || v.desc.toLowerCase().includes(q) || v.menu.some(m=>m.name.toLowerCase().includes(q)) || v.tags.join(' ').includes(q));
      renderVendors(filtered);
    });

    qsa('.chip[data-filter]').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        ch.classList.toggle('active');
        const active = qsa('.chip.active').map(el => el.dataset.filter).filter(Boolean);
        if(active.length === 0) renderVendors(state.vendors);
        else {
          const filtered = state.vendors.filter(v => active.some(a => v.tags.includes(a)));
          renderVendors(filtered);
        }
      });
    });

    qs('#clearSearch').addEventListener('click', ()=>{ qs('#search').value=''; renderVendors(state.vendors); });

    /* ---------- Profile persistence & mock accounts (project plan requires user accounts/profiles) ---------- */
    qs('#saveProfileLocal').addEventListener('click', ()=>{
      // Save dietary preference and name in localStorage (mock)
      const diet = qs('#dietPref').value; state.profile.diet = diet;
      state.profile.name = state.profile.name || 'Guest Student';
      localStorage.setItem('dd_profile', JSON.stringify(state.profile));
      alert('Profile saved locally (demo).');
      updateProfileDisplay();
    });

    qs('#loadProfileLocal').addEventListener('click', ()=>{
      state.profile = JSON.parse(localStorage.getItem('dd_profile') || '{}');
      qs('#dietPref').value = state.profile.diet || 'none';
      qs('#profileName').textContent = state.profile.name || 'Guest Student';
      qs('#profileEmail2').textContent = state.profile.email || 'Not signed in';
      qs('#profileSummary').textContent = state.profile.name || 'Guest Student';
      qs('#profileEmail').textContent = state.profile.email || 'Not signed in';
      alert('Profile loaded (demo).');
    });

    // simple mock sign-in to simulate accounts (project plan: register via uni email or SSO - here we simulate)
    qs('#openProfile').addEventListener('click', ()=>{
      const name = prompt('Sign in (demo). Enter your name to simulate a profile:');
      if(!name) return;
      state.profile.name = name;
      state.profile.email = (name.toLowerCase().replace(/\s/g,'.') + '@university.edu');
      localStorage.setItem('dd_profile', JSON.stringify(state.profile));
      updateProfileDisplay();
      alert('Signed in as ' + state.profile.name + ' (demo).');
    });

    function updateProfileDisplay(){
      qs('#profileName').textContent = state.profile.name || 'Guest Student';
      qs('#profileEmail2').textContent = state.profile.email || 'Not signed in';
      qs('#profileSummary').textContent = state.profile.name || 'Guest Student';
      qs('#profileEmail').textContent = state.profile.email || 'Not signed in';
    }

    updateProfileDisplay();

    /* ---------- Peer-to-peer delivery mock (apply to be driver) ---------- */
    qs('#applyDriverBtn').addEventListener('click', ()=>{
      const name = prompt('Apply to become a peer driver — enter your full name (demo):');
      if(!name) return;
      state.profile.driverApplication = {name, appliedAt: new Date().toISOString(), status:'pending'};
      localStorage.setItem('dd_profile', JSON.stringify(state.profile));
      alert('Application recorded (demo). You will be notified here when accepted (mock).');
    });

    /* ---------- Group & split orders (mock) ---------- */
    qs('#groupBtn').addEventListener('click', ()=>{
      const code = prompt('Create a group order: provide a name or room (e.g., "Study Group 5")');
      if(!code) return;
      const gid = 'G-' + Math.random().toString(36).slice(2,6).toUpperCase();
      state.group = { id: gid, name: code, members: [{name: state.profile.name || 'You', share:0}], createdAt: new Date().toISOString() };
      localStorage.setItem('dd_group', JSON.stringify(state.group));
      alert('Group created: ' + state.group.name + '\nShare code: ' + state.group.id + ' (demo)');
    });

    /* ---------- Ratings & Reviews (local) ---------- */
    function renderReviews(){
      reviewsList.innerHTML = '';
      if(state.reviews.length === 0){ reviewsList.innerHTML = '<div class="muted">No reviews yet. Leave feedback after delivery.</div>'; return; }
      state.reviews.forEach(r=>{
        const el = document.createElement('div'); el.className='review';
        el.innerHTML = `<div style="font-weight:700">${r.vendor} — <span class="rating">${r.rating}★</span></div><div class="muted">${r.text}</div><div class="muted" style="font-size:12px;margin-top:6px">${new Date(r.when).toLocaleString()}</div>`;
        reviewsList.appendChild(el);
      });
    }

    // allow leaving a review only when profile.history has recent order (simulated), but for demo provide a button when delivered
    qs('#viewReceipt').addEventListener('click', ()=>{
      // For demo, allow adding review for last order if exists
      const history = state.profile.history || [];
      if(history.length === 0){ alert('No orders in history to review (demo).'); return; }
      const last = history[history.length - 1];
      const vendorNames = Array.from(new Set(last.items.map(i=>i.vendorName)));
      // if multiple vendors in group, ask which to review
      const vendor = vendorNames[0];
      const rating = prompt('Leave a rating for ' + vendor + ' (1-5):');
      if(!rating) return;
      const text = prompt('Optional short review text (demo):') || '';
      state.reviews.push({vendor, rating: Number(rating), text, when: new Date().toISOString()});
      localStorage.setItem('dd_reviews', JSON.stringify(state.reviews));
      renderReviews();
      alert('Thanks — your review was recorded (demo).');
    });

    qs('#reportIssue').addEventListener('click', ()=> {
      const issue = prompt('Report an issue with your order (demo). Describe briefly:');
      if(!issue) return;
      // In the project plan reporting is supported — here we store in profile (demo)
      state.profile.lastReport = {text: issue, when: new Date().toISOString()};
      localStorage.setItem('dd_profile', JSON.stringify(state.profile));
      alert('Issue reported (demo). Support will follow up (mock).');
    });

    renderReviews();

    /* ---------- Accessibility toggles ---------- */
    qs('#contrastBtn').addEventListener('click', e=>{
      const pressed = e.getAttribute('aria-pressed') === 'true';
      e.setAttribute('aria-pressed', String(!pressed));
      if(!pressed){ document.documentElement.style.setProperty('--panel','rgba(255,255,255,0.06)'); document.documentElement.style.setProperty('--brand','#ffd54d'); }
      else { document.documentElement.style.removeProperty('--panel'); document.documentElement.style.removeProperty('--brand'); }
      state.settings.contrast = !pressed; localStorage.setItem('dd_settings', JSON.stringify(state.settings));
    });

    qs('#textBtn').addEventListener('click', e=>{
      const pressed = e.getAttribute('aria-pressed') === 'true';
      e.setAttribute('aria-pressed', String(!pressed));
      if(!pressed) document.documentElement.style.setProperty('font-size','17px');
      else document.documentElement.style.removeProperty('font-size');
      state.settings.largeText = !pressed; localStorage.setItem('dd_settings', JSON.stringify(state.settings));
    });

    qs('#reduceAnim').addEventListener('click', e=>{
      const pressed = e.getAttribute('aria-pressed') === 'true';
      e.setAttribute('aria-pressed', String(!pressed));
      if(!pressed) document.documentElement.style.setProperty('transition','none');
      else document.documentElement.style.removeProperty('transition');
      state.settings.reduceMotion = !pressed; localStorage.setItem('dd_settings', JSON.stringify(state.settings));
    });

    // keyboard shortcuts
    qs('#focusSearch').addEventListener('click', ()=>qs('#search').focus());
    document.addEventListener('keydown', e=>{
      if(e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA'){ e.preventDefault(); qs('#search').focus(); }
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k'){ e.preventDefault(); qs('#search').focus(); }
    });

    /* ---------- Small helpers / announcements ---------- */
    function announce(msg){
      let lr = qs('#__dd_live_'); if(!lr){ lr = document.createElement('div'); lr.id='__dd_live_'; lr.setAttribute('aria-live','polite'); lr.style.position='absolute'; lr.style.left='-9999px'; document.body.appendChild(lr); }
      lr.textContent = msg;
    }

    /* ---------- Initial render & restore ---------- */
    renderVendors(state.vendors);
    renderCart();

    if(state.settings.largeText) document.documentElement.style.setProperty('font-size','17px');
    if(state.settings.reduceMotion) document.documentElement.style.setProperty('transition','none');
    if(state.profile && state.profile.name){ updateProfileDisplay(); qs('#dietPref').value = state.profile.diet || 'none'; }

    if(state.activeOrder){ startTrackingSimulation(state.activeOrder); }

    /* ---------- Quick UI helpers ---------- */
    qs('#quickOrder').addEventListener('click', ()=>{ qs('#search').focus(); });
    qs('#howItWorks').addEventListener('click', ()=>{ alert('Deli-Drop connects students with campus vendors. Create an account (demo), find vendors, add items to cart, checkout (simulated), and track orders live (simulated).'); });

    // referral mock (project plan mentions referral bonuses)
    qs('#referralBtn').addEventListener('click', ()=>{
      const code = 'DD-' + Math.random().toString(36).slice(2,8).toUpperCase();
      alert('Share this referral code: ' + code + '\nYou and your friend earn credits on first order (demo).');
    });

    // persist any changes to profile automatically when changed by code paths above
  </script>
</body>
</html>
